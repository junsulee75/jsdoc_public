(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{150:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/kubeibm1-608b0544556265c5d4bb1c11e13773fb.png"},181:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/kubeibm2-d5c56ce2d433acb88e9e29c34799b52a.png"},182:function(e,t,n){"use strict";n.r(t),t.default=n.p+"assets/images/kubeibm3-128ced5401c6105c5db491df6352e687.png"},98:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return r})),n.d(t,"toc",(function(){return i})),n.d(t,"default",(function(){return c}));var a=n(3),l=(n(0),n(109));const o={id:"kubeibm",title:"MANAGING CONTAINER and KUBERNETES CLUSTER WITH IBM CLOUD",sidebar_label:"KUBERNETES ON IBM CLOUD hands on",slug:"/"},r={unversionedId:"kubeibm",id:"kubeibm",isDocsHomePage:!1,title:"MANAGING CONTAINER and KUBERNETES CLUSTER WITH IBM CLOUD",description:"Migrating my old article written on Dec.13, 2018 from other blog sites.",source:"@site/docs/kubeibm.md",slug:"/",permalink:"/jsdoc_public/docs/",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/kubeibm.md",version:"current",sidebar_label:"KUBERNETES ON IBM CLOUD hands on",sidebar:"someSidebar",next:{title:"Setting up Docusaurus",permalink:"/jsdoc_public/docs/docusaurus"}},i=[{value:"1. Create Kubenetes cluster.",id:"1-create-kubenetes-cluster",children:[]},{value:"2. Install softwares on your laptop.",id:"2-install-softwares-on-your-laptop",children:[{value:"2-1. Install IBM Cloud CLI",id:"2-1-install-ibm-cloud-cli",children:[]},{value:"2-2. IBM Cloud Kubernetes Service plug-in",id:"2-2-ibm-cloud-kubernetes-service-plug-in",children:[]},{value:"2-3. IBM Cloud Container Registry plug-in",id:"2-3-ibm-cloud-container-registry-plug-in",children:[]},{value:"2-4. Check installed plugin so far",id:"2-4-check-installed-plugin-so-far",children:[]},{value:"2-5. Install Kubenetes CLI softwares ( &#39;kubectl&#39; )",id:"2-5-install-kubenetes-cli-softwares--kubectl-",children:[]}]},{value:"3. Access to your Kubernetes cluster",id:"3-access-to-your-kubernetes-cluster",children:[{value:"3-1. Login with the provided URL from you cluster and set region as advised.",id:"3-1-login-with-the-provided-url-from-you-cluster-and-set-region-as-advised",children:[]},{value:"3-2. Download Kubenetes cluster configuration file.",id:"3-2-download-kubenetes-cluster-configuration-file",children:[]},{value:"3-3. Set &#39;KUBECONFIG&#39; environment and confirm if you can get the Kubenetes node name.",id:"3-3-set-kubeconfig-environment-and-confirm-if-you-can-get-the-kubenetes-node-name",children:[]}]},{value:"4. Push an Docker Image to IBM Cloud container registry",id:"4-push-an-docker-image-to-ibm-cloud-container-registry",children:[{value:"4-1. Need to login container registry",id:"4-1-need-to-login-container-registry",children:[]},{value:"4-2. Create your name space for uploading the image.",id:"4-2-create-your-name-space-for-uploading-the-image",children:[]},{value:"4-3. Build a Docker image.",id:"4-3-build-a-docker-image",children:[]},{value:"4-4. Push the Docker image to container registry of your IBM cloud.",id:"4-4-push-the-docker-image-to-container-registry-of-your-ibm-cloud",children:[]}]},{value:"5. Deploy the application to your Kubernetes cluster",id:"5-deploy-the-application-to-your-kubernetes-cluster",children:[{value:"5-1. Make sure Kubernetes cluster is ready.",id:"5-1-make-sure-kubernetes-cluster-is-ready",children:[]},{value:"5-2. Run the image as a deployment",id:"5-2-run-the-image-as-a-deployment",children:[]},{value:"5-3. Check if the deployed application is running.",id:"5-3-check-if-the-deployed-application-is-running",children:[]},{value:"5-4. Expose that deployment as a service, which is accessed through the IP of the worker nodes.",id:"5-4-expose-that-deployment-as-a-service-which-is-accessed-through-the-ip-of-the-worker-nodes",children:[]},{value:"5-5. Find the port that is used on that worker node and examine your new service",id:"5-5-find-the-port-that-is-used-on-that-worker-node-and-examine-your-new-service",children:[]},{value:"5-6. Find public IP",id:"5-6-find-public-ip",children:[]},{value:"5-7. Run application",id:"5-7-run-application",children:[]}]},{value:"6. Scale apps with replicas",id:"6-scale-apps-with-replicas",children:[{value:"6-1. Edit the application profile to have multiple replicas.",id:"6-1-edit-the-application-profile-to-have-multiple-replicas",children:[]},{value:"6-2. Now, check the application status again.",id:"6-2-now-check-the-application-status-again",children:[]}]},{value:"7. Update and rollback apps",id:"7-update-and-rollback-apps",children:[{value:"7-1.  Building new docker image and push to IBM cloud container registry.",id:"7-1--building-new-docker-image-and-push-to-ibm-cloud-container-registry",children:[]},{value:"7-2.  Roll out new image to Kubenetes cluster.",id:"7-2--roll-out-new-image-to-kubenetes-cluster",children:[]},{value:"7-3.  Roll out new image to Kubenetes cluster.",id:"7-3--roll-out-new-image-to-kubenetes-cluster",children:[]},{value:"7-4. Roll back apps",id:"7-4-roll-back-apps",children:[]}]}],s={toc:i};function c({components:e,...t}){return Object(l.b)("wrapper",Object(a.a)({},s,t,{components:e,mdxType:"MDXLayout"}),Object(l.b)("p",null,"Migrating my old article written on Dec.13, 2018 from other blog sites.",Object(l.b)("br",{parentName:"p"}),"\n","This is quite old doc but over streams remain similar.    "),Object(l.b)("p",null,"Recent few year's technologies are moving faster than the things that had happened last 20 years.",Object(l.b)("br",{parentName:"p"}),"\n","Among those, I am writing this page regarding how to start to create environment on your working laptop and interact with Kubernetes cluster in IBM cloud.",Object(l.b)("br",{parentName:"p"}),"\n",'Basically, the steps are followed by the course "Container & Kubernetes Essentials with IBM Cloud".',Object(l.b)("br",{parentName:"p"}),"\n","I know these are basic stuffs.",Object(l.b)("br",{parentName:"p"}),"\n","But during the hands on, I had few things that took my time to figure out some of trial and errors.",Object(l.b)("br",{parentName:"p"}),"\n","Therefore I hope this page could be useful as a supplement document that saves your time in the same occurrences.  "),Object(l.b)("p",null,"Firstly, I think it's better to share the example to create Kubenetes cluster environment in IBM Cloud",Object(l.b)("br",{parentName:"p"}),"\n","and the steps to setup your laptop environment based on the access information to the created cluster.",Object(l.b)("br",{parentName:"p"}),"\n","The overall steps would be conceptually similar to other clouds such as AWS and Google cloud.",Object(l.b)("br",{parentName:"p"}),"\n","(Note : This is the 1st version of document and will be updated if things change. )     "),Object(l.b)("h2",{id:"1-create-kubenetes-cluster"},"1. Create Kubenetes cluster."),Object(l.b)("p",null,"Simpler than cooking an instant noodle."),Object(l.b)("p",null,"Log in ",Object(l.b)("a",Object(a.a)({parentName:"p"},{href:"https://cloud.ibm.com"}),"IBM Cloud"),".",Object(l.b)("br",{parentName:"p"}),"\n","From 'Catalog' menu, choose 'Kubernetes service'.\nThen create the cluster giving the name.  ( 'mycluster' in my example. )     "),Object(l.b)("p",null,Object(l.b)("img",{alt:"alt text",src:n(150).default,title:"catalog page"})),Object(l.b)("p",null,"The screen during the deployment. ( It takes minutes. )"),Object(l.b)("p",null,Object(l.b)("img",{alt:"alt text",src:n(181).default,title:"deployment"})),Object(l.b)("p",null,"Once it's done, you will see this status that means your Kubenetes cluster is ready.   "),Object(l.b)("p",null,Object(l.b)("img",{alt:"alt text",src:n(182).default,title:"deployment"})),Object(l.b)("p",null,"When you click 'Access' tab, you will see the brief steps/commands how you access the cluster from your laptop.",Object(l.b)("br",{parentName:"p"}),"\n","I omit this as I will describe this later.",Object(l.b)("br",{parentName:"p"}),"\n","Beforehand, you will need to install some software stacks."),Object(l.b)("h2",{id:"2-install-softwares-on-your-laptop"},"2. Install softwares on your laptop."),Object(l.b)("p",null,"In short, we need IBM cloud CLI ( command line interface ) and Kubernetes interface.",Object(l.b)("br",{parentName:"p"}),"\n","I assume you already have at least Docker community edition installed in your laptop.",Object(l.b)("br",{parentName:"p"}),"\n","You may refer the page ",Object(l.b)("a",Object(a.a)({parentName:"p"},{href:"https://cloud.ibm.com/docs/cli/index.html#overview"}),"IBM Cloud CLI"),", Version 0.5.0 or later for the detail.",Object(l.b)("br",{parentName:"p"}),"\n","Regard '$' as the command prompt to run commands.   "),Object(l.b)("p",null,"The following commands install many relevant softwares and plug-in."),Object(l.b)("h3",{id:"2-1-install-ibm-cloud-cli"},"2-1. Install IBM Cloud CLI"),Object(l.b)("p",null,"After this you can use 'ibmcloud' command."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ curl -sL https://ibm.biz/idt-installer| bash\n")),Object(l.b)("h3",{id:"2-2-ibm-cloud-kubernetes-service-plug-in"},"2-2. IBM Cloud Kubernetes Service plug-in"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ ibmcloud plugin install container-service -r Bluemix\n")),Object(l.b)("h3",{id:"2-3-ibm-cloud-container-registry-plug-in"},"2-3. IBM Cloud Container Registry plug-in"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ ibmcloud plugin install container-registry -r Bluemix\n")),Object(l.b)("h3",{id:"2-4-check-installed-plugin-so-far"},"2-4. Check installed plugin so far"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ ibmcloud plugin list\n   Listing installed plug-ins...\n\nPlugin Name                            Version   Status   \ncloud-functions/wsk/functions/fn       1.0.24       \ncontainer-registry                     0.1.341      \ncontainer-service/kubernetes-service   0.1.635      \ndev                                    2.1.8        \nsdk-gen                                0.1.12  \n")),Object(l.b)("h3",{id:"2-5-install-kubenetes-cli-softwares--kubectl-"},"2-5. Install Kubenetes CLI softwares ( 'kubectl' )"),Object(l.b)("p",null,"This is from Kubernetes web site and not IBM cloud dependant."),Object(l.b)("p",null,"Refer to the page ",Object(l.b)("a",Object(a.a)({parentName:"p"},{href:"https://kubernetes.io/docs/tasks/tools/install-kubectl/"}),"Kubernetes CLI"),".\nIn short, only one command to install."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ brew install kubernetes-cli \n$ kubectl version\n")),Object(l.b)("h2",{id:"3-access-to-your-kubernetes-cluster"},"3. Access to your Kubernetes cluster"),Object(l.b)("p",null,"When I created the cluster, it seems my cluster was located to Sydney region from the provided API point.",Object(l.b)("br",{parentName:"p"}),"\n","By the way, I set up my access point and login.    "),Object(l.b)("h3",{id:"3-1-login-with-the-provided-url-from-you-cluster-and-set-region-as-advised"},"3-1. Login with the provided URL from you cluster and set region as advised."),Object(l.b)("p",null,"Once it's set once, you can use simple command ",Object(l.b)("inlineCode",{parentName:"p"},"ibmcloud login")," next time."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ ibmcloud login -a https://api.au-syd.bluemix.net\nAPI endpoint: https://api.au-syd.bluemix.net\n\nEmail> junsulee@au1.ibm.com\n\nPassword>  <== XXXXX\nAuthenticating...\nOK\n\nTargeted account JUN SU LEE's Account (bf384e9f77ea0cd3b2268cbc7a1b8871)\n\nTargeted resource group default\n\n                      \nAPI endpoint:      https://api.au-syd.bluemix.net\nRegion:            au-syd   \nUser:              junsulee@au1.ibm.com\nAccount:           JUN SU LEE's Account (bf384e9f77ea0cd3b2268cbc7a1b8871)   \nResource group:    default   \nCF API endpoint:      \nOrg:                  \nSpace:                \n..\n\n\n$ ibmcloud cs region-set ap-south\n")),Object(l.b)("h3",{id:"3-2-download-kubenetes-cluster-configuration-file"},"3-2. Download Kubenetes cluster configuration file."),Object(l.b)("p",null,"This will download and show the yaml file path with export command to set the client working environment."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ ibmcloud cs cluster-config mycluster\nOK\nThe configuration for mycluster was downloaded successfully.\n\nExport environment variables to start using Kubernetes.\n\nexport KUBECONFIG=/Users/kr050496/.bluemix/plugins/container-service/clusters/mycluster/kube-config-mel01-mycluster.yml\n")),Object(l.b)("h3",{id:"3-3-set-kubeconfig-environment-and-confirm-if-you-can-get-the-kubenetes-node-name"},"3-3. Set 'KUBECONFIG' environment and confirm if you can get the Kubenetes node name."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ export KUBECONFIG=/Users/kr050496/.bluemix/plugins/container-service/clusters/mycluster/kube-config-mel01-mycluster.yml\n\n\n$ kubectl get nodes\nNAME            STATUS   ROLES    AGE   VERSION\n10.118.181.83   Ready    <none>   9d    v1.10.8+IKS\n")),Object(l.b)("h2",{id:"4-push-an-docker-image-to-ibm-cloud-container-registry"},"4. Push an Docker Image to IBM Cloud container registry"),Object(l.b)("h3",{id:"4-1-need-to-login-container-registry"},"4-1. Need to login container registry"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"    $ ibmcloud cr login\n")),Object(l.b)("h3",{id:"4-2-create-your-name-space-for-uploading-the-image"},"4-2. Create your name space for uploading the image."),Object(l.b)("p",null,"I used 'js_namespace' here.   "),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ ibmcloud cr namespace-add js_namespace\n")),Object(l.b)("h3",{id:"4-3-build-a-docker-image"},"4-3. Build a Docker image."),Object(l.b)("p",null,"This could be any Docker image you have.",Object(l.b)("br",{parentName:"p"}),"\n","Here, I just used popular 'hello-world' app docker source files.",Object(l.b)("br",{parentName:"p"}),"\n","You can download the files from this github page.   "),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ docker build --tag registry.au-syd.bluemix.net/js_namespace/hello-world .\n\n$ docker images\nREPOSITORY                                             TAG                 IMAGE ID            CREATED             SIZE\nregistry.au-syd.bluemix.net/js_namespace/hello-world   latest              c8d3ce58b2f0        3 minutes ago       77.4MB\nnode                                                   9.4.0-alpine        b5f94997f35f        10 months ago       68MB\n")),Object(l.b)("h3",{id:"4-4-push-the-docker-image-to-container-registry-of-your-ibm-cloud"},"4-4. Push the Docker image to container registry of your IBM cloud."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ docker push registry.au-syd.bluemix.net/js_namespace/hello-world\n\nThe push refers to repository [registry.au-syd.bluemix.net/js_namespace/hello-world]\ndfed013c3a66: Pushed\n43c75a864aef: Pushed\na5e384757789: Pushed\n0804854a4553: Pushed\n6bd4a62f5178: Pushed\n9dfa40a0da3b: Pushed\nlatest: digest: sha256:03555979df6473d6bac5bd96aa567b732f5812bcec21d7849fd0a8df0d5260e4 size: 1576\n")),Object(l.b)("h2",{id:"5-deploy-the-application-to-your-kubernetes-cluster"},"5. Deploy the application to your Kubernetes cluster"),Object(l.b)("h3",{id:"5-1-make-sure-kubernetes-cluster-is-ready"},"5-1. Make sure Kubernetes cluster is ready."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ ibmcloud cs clusters\nOK\nName        ID                                 State    Created      Workers   Location   Version       Resource Group Name   \nmycluster   fc8d5b31551f40c393bb55dfbc7dacf1   normal   1 week ago   1         mel01      1.10.8_1530   default\n")),Object(l.b)("h3",{id:"5-2-run-the-image-as-a-deployment"},"5-2. Run the image as a deployment"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ kubectl run hello-world--image=registry.au-syd.bluemix.net/js_namespace/hello-world\n\nkubectl run --generator=deployment/apps.v1beta1 is DEPRECATED and will be removed in a future version. Use kubectl create instead.\ndeployment.apps/hello-world created\n")),Object(l.b)("h3",{id:"5-3-check-if-the-deployed-application-is-running"},"5-3. Check if the deployed application is running."),Object(l.b)("p",null,"( ",Object(l.b)("inlineCode",{parentName:"p"},"Pods")," is a kind of real running instance of the application image. )"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ kubectl get pods\nNAME                         READY   STATUS    RESTARTS   AGE\nhello-world-b5f57696-tw69g   1/1     Running   0          1m\n")),Object(l.b)("h3",{id:"5-4-expose-that-deployment-as-a-service-which-is-accessed-through-the-ip-of-the-worker-nodes"},"5-4. Expose that deployment as a service, which is accessed through the IP of the worker nodes."),Object(l.b)("p",null,"The example for this lab listens on port 8080. Run this command:    "),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),'$ kubectl expose deployment/hello-world --type="NodePort" --port=8080\nservice/hello-world exposed\n')),Object(l.b)("h3",{id:"5-5-find-the-port-that-is-used-on-that-worker-node-and-examine-your-new-service"},"5-5. Find the port that is used on that worker node and examine your new service"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ kubectl describe service hello-world\nName:                     hello-world\nNamespace:                default\nLabels:                   run=hello-world\nAnnotations:              <none>\nSelector:                 run=hello-world\nType:                     NodePort\nIP:                       172.21.221.176\nPort:                     <unset>  8080/TCP\nTargetPort:               8080/TCP\nNodePort:                 <unset>  32115/TCP\nEndpoints:                172.30.209.7:8080\nSession Affinity:         None\nExternal Traffic Policy:  Cluster\nEvents:                   <none>\n")),Object(l.b)("h3",{id:"5-6-find-public-ip"},"5-6. Find public IP"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ ibmcloud cs workers mycluster\nOK\nID                                                 Public IP       Private IP      Machine Type   State    Status   Zone    Version   \nkube-mel01-pafc8d5b31551f40c393bb55dfbc7dacf1-w1   168.1.144.249   10.118.181.83   free           normal   Ready    mel01   1.10.8_1531*   \n")),Object(l.b)("h3",{id:"5-7-run-application"},"5-7. Run application"),Object(l.b)("p",null,"(CLI example)"),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ curl 168.1.144.249:32115\nHello world from hello-world-b5f57696-tw69g! Your app is up and running in a cluster!\n")),Object(l.b)("p",null,"(From Web browser),"),Object(l.b)("p",null,Object(l.b)("img",{alt:"alt text",src:n(150).default,title:"catalog page"})," "),Object(l.b)("h2",{id:"6-scale-apps-with-replicas"},"6. Scale apps with replicas"),Object(l.b)("p",null,"Now, we about about to test replicating the applications that is one of main reason using Kubernetes.",Object(l.b)("br",{parentName:"p"}),"\n","This is how it looks like.   "),Object(l.b)("h3",{id:"6-1-edit-the-application-profile-to-have-multiple-replicas"},"6-1. Edit the application profile to have multiple replicas."),Object(l.b)("p",null,"This command opens editor like vi.    "),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),'$ kubectl edit deployment/hello-world\n\n..\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  annotations:\n    deployment.kubernetes.io/revision: "1"\n  creationTimestamp: 2018-12-02T08:12:32Z\n  generation: 1\n  labels:\n    run: hello-world\n  name: hello-world\n  namespace: default\n  resourceVersion: "89518"\n  selfLink: /apis/extensions/v1beta1/namespaces/default/deployments/hello-world\n  uid: 0500e431-f60a-11e8-a202-96b9c26aee95\nspec:\n  progressDeadlineSeconds: 600\n  replicas: 1                 <== change this line from 1 to 10\n')),Object(l.b)("p",null,"If you save by ",Object(l.b)("inlineCode",{parentName:"p"},"wq:"),", it shows the following message.      "),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),'..\n"/private/var/folders/3s/twhgptds155072zvjvs4q8j40000gn/T/kubectl-edit-ixhu1.yaml" 67L, 1935C written\ndeployment.extensions/hello-world edited\n')),Object(l.b)("h3",{id:"6-2-now-check-the-application-status-again"},"6-2. Now, check the application status again."),Object(l.b)("p",null,"Then you will see 10 Pods are running as we changed.",Object(l.b)("br",{parentName:"p"}),"\n","( It may take seconds until you see the output similar to this. )       "),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),'$ kubectl rollout status deployment/hello-world\ndeployment "hello-world" successfully rolled out\n\n$ kubectl get pods\nNAME                         READY   STATUS    RESTARTS   AGE\nhello-world-b5f57696-2gwkp   1/1     Running   0          2m\nhello-world-b5f57696-2vb6x   1/1     Running   0          2m\nhello-world-b5f57696-86bdz   1/1     Running   0          2m\nhello-world-b5f57696-9xcss   1/1     Running   0          2m\nhello-world-b5f57696-g96sw   1/1     Running   0          2m\nhello-world-b5f57696-hvd2f   1/1     Running   0          2m\nhello-world-b5f57696-jncsm   1/1     Running   0          2m\nhello-world-b5f57696-mdnkw   1/1     Running   0          2m\nhello-world-b5f57696-tc6k5   1/1     Running   0          2m\nhello-world-b5f57696-tw69g   1/1     Running   0          19m\n')),Object(l.b)("h2",{id:"7-update-and-rollback-apps"},"7. Update and rollback apps"),Object(l.b)("p",null,"Kubernetes allows you to use a rollout to update an app deployment with a new Docker image.",Object(l.b)("br",{parentName:"p"}),"\n","This allows you to easily update the running image and also allows you to easily undo a rollout if a problem is discovered after deployment.     "),Object(l.b)("h3",{id:"7-1--building-new-docker-image-and-push-to-ibm-cloud-container-registry"},"7-1.  Building new docker image and push to IBM cloud container registry."),Object(l.b)("p",null,'Let me build two more docker images tagging ":1" and ":2" to differentiate from the previous version.',Object(l.b)("br",{parentName:"p"}),"\n","This is actually same build but I will pretend these are different version just for demonstration purpose.     "),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ docker build --tag registry.au-syd.bluemix.net/js_namespace/hello-world:1 .\n\nSending build context to Docker daemon  15.36kB\nStep 1/6 : FROM node:9.4.0-alpine\n---\x3e b5f94997f35f\nStep 2/6 : COPY app.js .\n---\x3e Using cache\n---\x3e 0bdfcf16e9c0\nStep 3/6 : COPY package.json .\n---\x3e Using cache\n---\x3e b7a6a0b93944\nStep 4/6 : RUN npm install &&    apk update &&    apk upgrade\n---\x3e Using cache\n---\x3e 4c0b6dad22d4\nStep 5/6 : EXPOSE  8080\n---\x3e Using cache\n---\x3e bda855584f19\nStep 6/6 : CMD node app.js\n---\x3e Using cache\n---\x3e c8d3ce58b2f0\nSuccessfully built c8d3ce58b2f0\nSuccessfully tagged registry.au-syd.bluemix.net/js_namespace/hello-world:1\n")),Object(l.b)("p",null,"Now, you see one more build."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ docker images\nREPOSITORY                                             TAG                 IMAGE ID            CREATED             SIZE\nregistry.au-syd.bluemix.net/js_namespace/hello-world   1                   c8d3ce58b2f0        4 hours ago         77.4MB\nregistry.au-syd.bluemix.net/js_namespace/hello-world   latest              c8d3ce58b2f0        4 hours ago         77.4MB\nnode                                                   9.4.0-alpine        b5f94997f35f        10 months ago       68MB\n")),Object(l.b)("p",null,"Then, I will push this new image to IBM cloud container registry.     "),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ docker push registry.au-syd.bluemix.net/js_namespace/hello-world:1\nThe push refers to repository [registry.au-syd.bluemix.net/js_namespace/hello-world]\ndfed013c3a66: Layer already exists\n43c75a864aef: Layer already exists\na5e384757789: Layer already exists\n0804854a4553: Layer already exists\n6bd4a62f5178: Layer already exists\n9dfa40a0da3b: Layer already exists\n1: digest: sha256:03555979df6473d6bac5bd96aa567b732f5812bcec21d7849fd0a8df0d5260e4 size: 1576\n")),Object(l.b)("p",null,'In the same way, let me build one more version tagging as ":2".',Object(l.b)("br",{parentName:"p"}),"\n","Finally, I will use this for the test.      "),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ docker build --tag registry.au-syd.bluemix.net/js_namespace/hello-world:2 .\n\nSending build context to Docker daemon  15.36kB\nStep 1/6 : FROM node:9.4.0-alpine\n---\x3e b5f94997f35f\nStep 2/6 : COPY app.js .\n---\x3e Using cache\n---\x3e 0bdfcf16e9c0\nStep 3/6 : COPY package.json .\n---\x3e Using cache\n---\x3e b7a6a0b93944\nStep 4/6 : RUN npm install &&    apk update &&    apk upgrade\n---\x3e Using cache\n---\x3e 4c0b6dad22d4\nStep 5/6 : EXPOSE  8080\n---\x3e Using cache\n---\x3e bda855584f19\nStep 6/6 : CMD node app.js\n---\x3e Using cache\n---\x3e c8d3ce58b2f0\nSuccessfully built c8d3ce58b2f0\nSuccessfully tagged registry.au-syd.bluemix.net/js_namespace/hello-world:2\n\n\n$ docker images\nREPOSITORY                                             TAG                 IMAGE ID            CREATED             SIZE\nregistry.au-syd.bluemix.net/js_namespace/hello-world   1                   c8d3ce58b2f0        4 hours ago         77.4MB\nregistry.au-syd.bluemix.net/js_namespace/hello-world   2                   c8d3ce58b2f0        4 hours ago         77.4MB\nregistry.au-syd.bluemix.net/js_namespace/hello-world   latest              c8d3ce58b2f0        4 hours ago         77.4MB\nnode                                                   9.4.0-alpine        b5f94997f35f        10 months ago       68MB\n\n\n$ docker push registry.au-syd.bluemix.net/js_namespace/hello-world:2\n\nThe push refers to repository [registry.au-syd.bluemix.net/js_namespace/hello-world]\ndfed013c3a66: Layer already exists\n43c75a864aef: Layer already exists\na5e384757789: Layer already exists\n0804854a4553: Layer already exists\n6bd4a62f5178: Layer already exists\n9dfa40a0da3b: Layer already exists\n2: digest: sha256:03555979df6473d6bac5bd96aa567b732f5812bcec21d7849fd0a8df0d5260e4 size: 1576\n")),Object(l.b)("h3",{id:"7-2--roll-out-new-image-to-kubenetes-cluster"},"7-2.  Roll out new image to Kubenetes cluster."),Object(l.b)("p",null,"So far, I have only pushed this image into the container registry only but didn't roll out to Kubenetes service cluster.     "),Object(l.b)("p",null,"To apply new image, there are two ways.    "),Object(l.b)("p",null,"(1) Edit the Kubenetes application profile and save. ( Edit the image name line )    "),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ kubectl edit deployment/hello-world\n\n..\n    spec:\n      containers:\n     - image: registry.au-syd.bluemix.net/js_namespace/hello-world:2\n")),Object(l.b)("p",null,"(2) By commands."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),'\n$ kubectl set image deployment/hello-world hello-world=registry.au-syd.bluemix.net/js_namespace/hello-world:2\ndeployment.extensions/hello-world image updated\n..\n\n$ kubectl rollout status deployment/hello-world\ndeployment "hello-world" successfully rolled out\n')),Object(l.b)("p",null,"Can you guess what would happen then ?",Object(l.b)("br",{parentName:"p"}),"\n","Yes, the existing replicasets moved to sets with new image.",Object(l.b)("br",{parentName:"p"}),"\n","I hoped to capture the progress of the movement but it was too fast, so I show the result output after the movement.     "),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ kubectl get replicasets\nNAME                     DESIRED   CURRENT   READY   AGE\nhello-world-854fc7484d   10        10        10      1m    <= new\nhello-world-b5f57696     0         0         0       34m   <= old\n")),Object(l.b)("h3",{id:"7-3--roll-out-new-image-to-kubenetes-cluster"},"7-3.  Roll out new image to Kubenetes cluster."),Object(l.b)("p",null,"Running the application confirms we are running on the new image.     "),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ curl 168.1.144.249:32115\nHello world from hello-world-854fc7484d-qnxf8! Your app is up and running in a cluster!\n")),Object(l.b)("h3",{id:"7-4-roll-back-apps"},"7-4. Roll back apps"),Object(l.b)("p",null,"Let's assume the scenario that something goes wrong with new apps image.",Object(l.b)("br",{parentName:"p"}),"\n","Here, one single quick command to rollback the change.",Object(l.b)("br",{parentName:"p"}),"\n","At this time, I am more prepared to run the command in shorter interval to show the progress.    "),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"$ kubectl rollout undo deployment/hello-world\ndeployment.extensions/hello-world\n\njsmacpro15retina:Lab 1 kr050496$ kubectl get replicasets\nNAME                     DESIRED   CURRENT   READY   AGE\nhello-world-854fc7484d   6         6         6       3m\nhello-world-b5f57696     7         7         2       36m\n\njsmacpro15retina:Lab 1 kr050496$ kubectl get replicasets\nNAME                     DESIRED   CURRENT   READY   AGE\nhello-world-854fc7484d   4         4         4       3m\nhello-world-b5f57696     9         9         4       37m\n\njsmacpro15retina:Lab 1 kr050496$ kubectl get replicasets\nNAME                     DESIRED   CURRENT   READY   AGE\nhello-world-854fc7484d   4         4         4       3m\nhello-world-b5f57696     9         9         4       37m\n\njsmacpro15retina:Lab 1 kr050496$ kubectl get replicasets\nNAME                     DESIRED   CURRENT   READY   AGE\nhello-world-854fc7484d   4         4         4       4m\nhello-world-b5f57696     9         9         4       37m\n\njsmacpro15retina:Lab 1 kr050496$ kubectl get replicasets\nNAME                     DESIRED   CURRENT   READY   AGE\nhello-world-854fc7484d   2         2         2       4m\nhello-world-b5f57696     10        10        6       37m\n\njsmacpro15retina:Lab 1 kr050496$ kubectl get replicasets\nNAME                     DESIRED   CURRENT   READY   AGE\nhello-world-854fc7484d   2         2         2       4m\nhello-world-b5f57696     10        10        7       37m\n\njsmacpro15retina:Lab 1 kr050496$ kubectl get replicasets\nNAME                     DESIRED   CURRENT   READY   AGE\nhello-world-854fc7484d   0         0         0       4m\nhello-world-b5f57696     10        10        8       37m\n\njsmacpro15retina:Lab 1 kr050496$ kubectl get replicasets\nNAME                     DESIRED   CURRENT   READY   AGE\nhello-world-854fc7484d   0         0         0       4m\nhello-world-b5f57696     10        10        10      37m\n\n")),Object(l.b)("p",null,"Now we went back to the previous image running mode.",Object(l.b)("br",{parentName:"p"}),"\n","Thank you for reading this.     "))}c.isMDXComponent=!0}}]);